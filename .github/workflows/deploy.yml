name: Deploy to Cloud Run

on:
  push:
    branches:
      - master

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  # Default to 'us-central1' if variable is not set
  GCP_REGION: ${{ vars.GCP_REGION || 'us-central1' }}
  # Default Service Name
  SERVICE_NAME: ${{ vars.SERVICE_NAME || 'meshcentral-server' }}
  DOMAIN: ${{ vars.DOMAIN }}
  MESHCENTRAL_VERSION: ${{ vars.MESHCENTRAL_VERSION }}
  
  # Resource Configuration (Defaults)
  # Scale to Zero settings
  MIN_SCALE: ${{ vars.MIN_SCALE || '0' }}
  MAX_SCALE: ${{ vars.MAX_SCALE || '3' }}
  
  # Resource Limits
  INGRESS_CPU: ${{ vars.INGRESS_CPU || '100m' }}
  INGRESS_MEMORY: ${{ vars.INGRESS_MEMORY || '128Mi' }}
  
  MESH_CPU: ${{ vars.MESH_CPU || '1000m' }}
  MESH_MEMORY: ${{ vars.MESH_MEMORY || '1Gi' }}
  
  TUNNEL_CPU: ${{ vars.TUNNEL_CPU || '500m' }}
  TUNNEL_MEMORY: ${{ vars.TUNNEL_MEMORY || '256Mi' }}
  
  # Runtime Service Account (constructed per project standard)
  RUNTIME_SERVICE_ACCOUNT: meshcentral-runtime@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get secrets from Secret Manager
        id: secrets
        run: |
          MONGO_URL=$(gcloud secrets versions access latest --secret=mongo-url)
          echo "::add-mask::$MONGO_URL"
          echo "MONGO_URL=$MONGO_URL" >> $GITHUB_OUTPUT

          CLOUDFLARE_TOKEN=$(gcloud secrets versions access latest --secret=cloudflare-token)
          echo "::add-mask::$CLOUDFLARE_TOKEN"
          echo "CLOUDFLARE_TOKEN=$CLOUDFLARE_TOKEN" >> $GITHUB_OUTPUT

          OIDC_CLIENT_ID=$(gcloud secrets versions access latest --secret=oidc-client-id)
          echo "::add-mask::$OIDC_CLIENT_ID"
          echo "OIDC_CLIENT_ID=$OIDC_CLIENT_ID" >> $GITHUB_OUTPUT

          OIDC_CLIENT_SECRET=$(gcloud secrets versions access latest --secret=oidc-client-secret)
          echo "::add-mask::$OIDC_CLIENT_SECRET"
          echo "OIDC_CLIENT_SECRET=$OIDC_CLIENT_SECRET" >> $GITHUB_OUTPUT

          OIDC_ISSUER=$(gcloud secrets versions access latest --secret=oidc-issuer)
          echo "::add-mask::$OIDC_ISSUER"
          echo "OIDC_ISSUER=$OIDC_ISSUER" >> $GITHUB_OUTPUT

      - name: Generate config.json
        run: |
          cat > config.json <<'EOF'
          {
            "$schema": "http://info.meshcentral.com/downloads/meshcentral-config-schema.json",
            "settings": {
              "MongoDb": "${{ steps.secrets.outputs.MONGO_URL }}",
              "cert": "${{ env.DOMAIN }}",
              "AllowedOrigins": ["${{ env.DOMAIN }}", "https://${{ env.DOMAIN }}"],
              "ReferrerAliases": ["${{ env.DOMAIN }}"],
              "TrustedProxy": ["127.0.0.1", "::1"],
              "UserNameIsEmail": true,
              "RootCert": "/home/node/meshcentral-data/root-cert-public.crt",
              "RootKey": "/home/node/meshcentral-data/root-cert-private.key",
              "Port": 3000,
              "AliasPort": 443,
              "TlsOffload": "127.0.0.1",
              "SelfUpdate": false,
              "AllowLoginToken": true,
              "WANonly": true,
              "Minify": false
            },
            "domains": {
              "": {
                "certUrl": "https://${{ env.DOMAIN }}",
                "Title": "MeshCentral",
                "Title2": "Cloud Run",
                "NewAccounts": true,
                "authStrategies": {
                  "oidc": {
                    "issuer": "${{ steps.secrets.outputs.OIDC_ISSUER }}",
                    "clientid": "${{ steps.secrets.outputs.OIDC_CLIENT_ID }}",
                    "clientsecret": "${{ steps.secrets.outputs.OIDC_CLIENT_SECRET }}",
                    "newAccounts": true,
                    "client": {
                      "redirect_uri": "https://${{ env.DOMAIN }}/auth-oidc-callback"
                    }
                  }
                }
              }
            }
          }
          EOF

      - name: Upload config.json to GCS
        run: |
          BUCKET_NAME="meshcentral-data-${{ env.GCP_PROJECT_ID }}"
          GCS_PATH="gs://${BUCKET_NAME}/config.json"
          echo "Uploading config.json to $GCS_PATH..."
          gsutil cp config.json "$GCS_PATH"

      - name: Build and Push Docker image
        run: |
          # Configure docker to use gcloud as credential helper
          gcloud auth configure-docker gcr.io

          # Build Image (using the Dockerfile in root)
          docker build \
            --build-arg MESHCENTRAL_VERSION=${{ env.MESHCENTRAL_VERSION }} \
            -t gcr.io/${{ env.GCP_PROJECT_ID }}/meshcentral:${{ env.MESHCENTRAL_VERSION }} \
            .

          # Push to GCR
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/meshcentral:${{ env.MESHCENTRAL_VERSION }}

      - name: Prepare service.yaml with secrets
        run: |

          export MONGO_URL="${{ steps.secrets.outputs.MONGO_URL }}"
          export DOMAIN="${{ env.DOMAIN }}"
          export CLOUDFLARE_TOKEN="${{ steps.secrets.outputs.CLOUDFLARE_TOKEN }}"
          export GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}"
          export MESHCENTRAL_VERSION="${{ env.MESHCENTRAL_VERSION }}"
          export SERVICE_NAME="${{ env.SERVICE_NAME }}"
          
          # Scaling
          export MIN_SCALE="${{ env.MIN_SCALE }}"
          export MAX_SCALE="${{ env.MAX_SCALE }}"
          
          # Resources
          export INGRESS_CPU="${{ env.INGRESS_CPU }}"
          export INGRESS_MEMORY="${{ env.INGRESS_MEMORY }}"
          export MESH_CPU="${{ env.MESH_CPU }}"
          export MESH_MEMORY="${{ env.MESH_MEMORY }}"
          export TUNNEL_CPU="${{ env.TUNNEL_CPU }}"

          export TUNNEL_MEMORY="${{ env.TUNNEL_MEMORY }}"
          export RUNTIME_SERVICE_ACCOUNT="${{ env.RUNTIME_SERVICE_ACCOUNT }}"
          
          envsubst '${MONGO_URL} ${DOMAIN} ${CLOUDFLARE_TOKEN} ${GCP_PROJECT_ID} ${MESHCENTRAL_VERSION} ${SERVICE_NAME} ${MIN_SCALE} ${MAX_SCALE} ${INGRESS_CPU} ${INGRESS_MEMORY} ${MESH_CPU} ${MESH_MEMORY} ${TUNNEL_CPU} ${TUNNEL_MEMORY} ${RUNTIME_SERVICE_ACCOUNT}' < service.yaml > service.resolved.yaml

      - name: Deploy to Cloud Run
        run: |
          gcloud run services replace service.resolved.yaml --region ${{ env.GCP_REGION }}

      - name: Set scaling limits
        run: |
          gcloud run services update ${{ env.SERVICE_NAME }} --region ${{ env.GCP_REGION }} \
            --min-instances=${{ env.MIN_SCALE }} \
            --max-instances=${{ env.MAX_SCALE }}

      - name: Get service URL
        run: |
          WAKEUP_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.GCP_REGION }} --format 'value(status.url)')
          echo "Service URL: $WAKEUP_URL"
          echo "Access your service at: https://${{ env.DOMAIN }}"
